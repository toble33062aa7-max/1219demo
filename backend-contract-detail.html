<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>政府場域實證 - 後台案件管理系統 (個案管考詳情)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00796b;
            --secondary-bg: #f4f7f6;
            --text-main: #333;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --warning-color: #ff9800;
            --danger-color: #d32f2f;
            --info-color: #1976d2;
        }

        body {
            font-family: "Microsoft JhengHei", sans-serif;
            margin: 0;
            display: flex;
            background-color: var(--secondary-bg);
            color: var(--text-main);
        }

        /* 左側導覽列 */
        .sidebar { width: 240px; background-color: #fff; height: 100vh; border-right: 1px solid var(--border-color); position: fixed; }
        .sidebar-header { padding: 20px; background-color: var(--primary-color); color: white; font-weight: bold; font-size: 1.1rem; }
        .menu-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; color: #555; transition: 0.2s; }
        .menu-item i { width: 25px; margin-right: 10px; }
        .menu-item:hover, .menu-item.active { background-color: #e0f2f1; color: var(--primary-color); font-weight: bold; }

        /* 主要內容區 */
        .main-content { margin-left: 240px; width: calc(100% - 240px); padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* 案件卡片 */
        .case-card { background: white; padding: 20px; border-radius: 8px; border-left: 5px solid var(--primary-color); margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .case-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; }
        .case-meta { display: flex; gap: 20px; color: #666; font-size: 0.9rem; }
        .badge-status { background: #e3f2fd; color: #1976d2; padding: 3px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; }

        /* Stepper 進度條 */
        .stepper { display: flex; justify-content: space-around; background: white; padding: 25px 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step { text-align: center; flex: 1; color: #ccc; position: relative; font-size: 0.85rem; }
        .step.active { color: var(--primary-color); font-weight: bold; }
        .step.complete { color: var(--success-color); }
        .step i { font-size: 1.4rem; margin-bottom: 8px; display: block; }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 0px; border-bottom: 1px solid var(--border-color); }
        .tab { padding: 12px 30px; cursor: pointer; border-radius: 8px 8px 0 0; background: #eee; margin-right: 4px; color: #666; transition: 0.3s; }
        .tab.active { background: white; color: var(--primary-color); border: 1px solid var(--border-color); border-bottom: 2px solid white; font-weight: bold; }

        /* 表格區塊 */
        .content-box { background: white; padding: 20px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { background: #fcfcfc; color: #555; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
        .data-table td { padding: 15px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }

        /* 狀態標籤 */
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .tag-gray { background: #eee; color: #666; }
        .tag-blue { background: #e3f2fd; color: #1976d2; }
        .tag-green { background: #e8f5e9; color: #2e7d32; }
        .tag-orange { background: #fff3e0; color: #ef6c00; }

        /* 進度條樣式 */
        .progress-container { width: 100px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 5px; }
        .progress-bar { height: 100%; background: var(--primary-color); }

        /* 詳情區塊 */
        .hidden-row { display: none; background-color: #fafafa; }
        .expanded { display: table-row; }
        
        .detail-wrapper { padding: 20px; border: 1px solid #ddd; border-top: none; background: #fff; margin-bottom: 10px; }
        .management-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
        .section-title { font-size: 1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        
        /* 查核清單樣式 */
        .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 5px; background: #f9f9f9; border-radius: 4px; }
        .check-item input[type="checkbox"] { transform: scale(1.1); }

        /* 經費表格樣式 */
        .budget-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.85rem; }
        .budget-table th { background: #f0f0f0; padding: 6px; border: 1px solid #ddd; text-align: center; }
        .budget-table td { padding: 6px; border: 1px solid #ddd; text-align: right; }

        /* 可編輯樣式 */
        .editable { padding: 4px; border: 1px transparent solid; transition: 0.2s; border-radius: 3px; }
        .editing .editable { border: 1px dashed var(--info-color); background-color: #fffde7; outline: none; }
        .editing textarea {
			width: 100%;
			min-height: 200px; /* 從 80px 改為 200px 或更高 */
			border: 1px dashed var(--info-color);
			background-color: #fffde7;
			outline: none;
			padding: 10px;    /* 增加內邊距讓文字不擁擠 */
			font-size: 0.9rem; /* 調整字體大小 */
			line-height: 1.5;  /* 增加行高 */
		}
		textarea.editable {
			width: 100%;
			min-height: 200px; /* 保持一致的高度 */
			border: 1px solid #eee;
			background-color: #f9f9f9;
			resize: vertical;  /* 允許使用者手動拉伸高度 */
			padding: 10px;
		}
		/* 編輯模式下的樣式切換 */
	.editing .editable-text { 
		border: 1px dashed #1976d2 !important; 
		background-color: #fffde7 !important; 
		padding: 2px 5px;
	}

		/* 讓編輯模式下的新增/刪除按鈕現身 */
	.editing .btn-add-mini, 
	.editing .btn-del-mini { 
		display: inline-flex !important; 
	}

		/* 讓備註格變大且可編輯 */
	.editing textarea {
		background-color: #fffde7;
		border: 1px dashed #1976d2;
	}

        /* 按鈕樣式 */
        .btn { padding: 6px 14px; border-radius: 4px; cursor: pointer; border: none; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #555; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-edit { border: 1px solid var(--primary-color); color: var(--primary-color); background: white; }
        .btn-save { background: var(--success-color); color: white; display: none; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">計畫管理平台</div>
        <a href="backend-menu.html" class="menu-item"><i class="fa-solid fa-house"></i> 首頁總覽</a>
        <div class="menu-item active"><i class="fa-solid fa-folder-open"></i> 實證案件管理</div>
        <a href="backend-score.html" class="menu-item"><i class="fa-solid fa-file-contract"></i> 評分記錄</a>
        <a href="backend-statistical-reports.html" class="menu-item active"><i class="fa-solid fa-chart-line"></i> 統計報表</a>
        <a href="backend-setting.html" class="menu-item"><i class="fa-solid fa-gear"></i> 系統設定</a>
    </nav>

    <main class="main-content">
        <header>
            <div style="color: #666; font-size: 0.9rem;">實證案件 > 案件詳情 > 個案管考管理</div>
            <div>管理員：fangcy <i class="fa-solid fa-circle-user"></i></div>
        </header>

        <div class="case-card">
            <div class="case-title">
                114年度研發型補助計畫推動案
                <span class="badge-status">評選簽約階段</span>
            </div>
            <div class="case-meta">
                <span>案號：114-RD-001</span>
                <span>主辦單位：計畫管理組</span>
                <span>總廠商數：12 家</span>
            </div>
        </div>

        <<div class="stepper">
				<!-- 出題公告 -->
			    <div class="step complete" onclick="location.href='backend-challenge-management.html'" style="cursor: pointer;">
			        <i class="fa-solid fa-bullhorn"></i>出題公告
			    </div>

 			   <!-- 解題徵件 (目前頁面) -->
 			   <div class="step complete" onclick="location.href='backend-startup-management.html'" style="cursor: pointer;">
 			       <i class="fa-solid fa-lightbulb"></i>解題徵件
			    </div>

			    <!-- 評選簽約 -->
			    <div class="step active" onclick="location.href='backend-contract-management.html'" style="cursor: pointer;">
 			       <i class="fa-solid fa-file-signature"></i>評選簽約
 			   </div>

  			  <!-- 期中管考 -->
  			  <div class="step" onclick="location.href='backend-midterm-management.html'" style="cursor: pointer;">
			        <i class="fa-solid fa-list-check"></i>期中管考
 			   </div>

 			   <!-- 期末驗收 -->
 			   <div class="step" onclick="location.href='backend-acceptance-management.html'" style="cursor: pointer;">
 			       <i class="fa-solid fa-clipboard-check"></i>期末驗收
 			   </div>

 			   <!-- 結案請款 -->
 			   <div class="step" onclick="location.href='backend-2payment-management.html'" style="cursor: pointer;">
  			      <i class="fa-solid fa-box-archive"></i>結案請款
 			   </div>
		</div>

        <div class="tabs">
            <div class="tab" onclick="location.href='backend-contract-management.html'">簽約管考工項 (13-16)</div>
            <div class="tab active">個案管考詳情</div>
            
        </div>

        <div class="content-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1.1rem;">廠商簽約與請款管考總表</h3>
                <div style="display: flex; gap: 10px;">
                    <select style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                        <option>所有簽約狀態</option>
                        <option>文件審核中</option>
                        <option>已簽約待撥款</option>
                        <option>第一期款已撥付</option>
                    </select>
                    <button class="btn btn-primary"><i class="fa-solid fa-file-export"></i> 導出總清單</button>
                </div>
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="120">提案編號</th>
                        <th width="200">廠商名稱</th>
                        <th width="180">簽約進度</th>
                        <th width="120">撥款狀態</th>
                        <th width="150">最後更新日期</th>
                        <th width="100">管理</th>
                    </tr>
                </thead>
                <tbody id="caseTableBody">
                    <!-- 第一筆廠商：智通科技 -->
                    <tr id="row-1">
                        <td>114-T058-003</td>
                        <td>
                            <div style="font-weight:bold;">智通科技股份有限公司</div>
                            <div style="font-size:0.75rem; color:#888;">對應工項：15. 簽約收件</div>
                        </td>
                        <td>
                            <div class="progress-container"><div class="progress-bar" style="width: 75%;"></div></div>
                            <span style="font-size: 0.8rem;">75%</span>
                            <div style="font-size: 0.75rem; color: #1976d2;">文件複審中</div>
                        </td>
                        <td><span class="tag tag-orange">待撥付</span></td>
                        <td>2026/05/28 14:30</td>
                        <td>
                            <button class="btn btn-edit" onclick="toggleCaseDetails(1)"><i class="fa-solid fa-magnifying-glass"></i> 管考</button>
                        </td>
                    </tr>
                    <tr id="detail-1" class="hidden-row">
                        <td colspan="6">
                            <div class="detail-wrapper" id="wrapper-1">
                                <div class="management-grid">
                                    <!-- 左側：文件查核與基本資訊 -->
                                    <div>
                                        <div class="section-title">
                                            <span><i class="fa-solid fa-file-circle-check"></i> 簽約文件檢核 (工項15)</span>
											 <button class="btn btn-add-mini" onclick="addCheckItem(1)">+ 新增文件</button>
                                        </div>
                                        <div class="check-grid">
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">函文正本</span> </div>
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">契約書正本 (2份)</span> </div>
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">合作意向書(MOU)影本</span> </div>
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">公司專戶影本 (需含0元證明)</span> </div>
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">膠裝與騎縫章檢核</span> </div>
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">第一期款請款申請書</span> </div>
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">修正後計畫書 (定稿)</span> </div>
                                            <div class="check-item"><i class="fa-solid fa-trash-can btn-del-mini" onclick="this.parentElement.remove()"></i><input type="checkbox" checked> <span class="editable-text" contenteditable="false">領據/收據 (30%)</span> </div>
                                        </div>

                                        <div class="section-title" style="margin-top:20px;">
                                            <span><i class="fa-solid fa-address-card"></i> 聯繫窗口資管</span>
											<button class="btn btn-add-mini" onclick="addContactRow(1)">+ 新增聯繫人</button>
										</div>
											<table class="budget-table">
 											   <tbody id="contact-table-1">
 											       <tr>
 											           <th width="80" class="editable-text" contenteditable="false">專案經理</th>
											            <td class="editable-text" contenteditable="false">李小美</td>
											            <th width="80" class="editable-text" contenteditable="false">電話</th>
											            <td class="editable-text" contenteditable="false">02-2655-1234</td>
 											           <!-- 刪除按鈕 -->
 											           <td class="btn-del-mini" onclick="this.parentElement.remove()">×</td>
 											       </tr>
 											   </tbody>
											</table>
                                    </div>

                                    <!-- 右側：經費核定與撥款紀錄 -->
                                    <div>
                                        <div class="section-title">
                                            <span><i class="fa-solid fa-money-bill-transfer"></i> 經費核定與撥款 (工項16)</span>
											<button class="btn btn-add-mini" onclick="addBudgetRow(1)">+ 新增期別</button>
										</div>
										<table class="budget-table">
 										   <thead>
 										       <tr>
 										           <th>項目</th>
 										           <th>金額</th>
  										          <th>狀態</th>
  										          <th class="btn-del-mini">刪除</th>
 										       </tr>
  										  </thead>
 										   <tbody id="budget-table-1">
 										       <tr>
										            <td class="editable-text" contenteditable="false" style="text-align:left;">第一期款 (簽約)</td>
										            <td class="editable-text" contenteditable="false">660,000</td>
 										           <td class="editable-text" contenteditable="false">待請款</td>
										            <td class="btn-del-mini" onclick="this.parentElement.remove()">×</td>
 										       </tr>
 										   </tbody>
										</table>

                                        <div class="section-title" style="margin-top:20px;">
                                            <span><i class="fa-solid fa-note-sticky"></i> 管考備註與異常紀錄</span>
											 <button class="btn btn-add-mini" onclick="addCheckItem(1)">+ 新增文件</button>
                                        </div>
                                        <textarea id="note-1" class="editable" readonly placeholder="輸入管考紀錄，例如：5/28通知廠商補正專戶存摺封面、6/01預計召開內部審查會...">5/25 廠商提交之MOU影本未蓋與正本相符章，已退回請廠商修正。
5/28 計畫書會計修正意見已由歐會計師確認通過。</textarea>
                                    </div>
                                </div>

                                <div style="margin-top: 20px; text-align: right;">
									<!-- 預設顯示 -->
									    <button id="edit-btn-1" class="btn btn-edit" onclick="enterEditMode(1)">
 									       <i class="fa-solid fa-pen"></i> 進入編輯模式
 									   </button>
    
 									   <!-- 預設隱藏 (display:none) -->
 									   <button id="save-btn-1" class="btn btn-save" style="display:none" onclick="saveData(1)">
  									      <i class="fa-solid fa-check"></i> 儲存所有變更
  									  </button>
									</div>
                            </div>
                        </td>
                    </tr>

                    <!-- 第二筆廠商：雲端數據 -->
                    <tr id="row-2">
                        <td>114-T058-005</td>
                        <td>
                            <div style="font-weight:bold;">雲端數據應用實驗室</div>
                            <div style="font-size:0.75rem; color:#888;">對應工項：14. 經費審查</div>
                        </td>
                        <td>
                            <div class="progress-container"><div class="progress-bar" style="width: 40%;"></div></div>
                            <span style="font-size: 0.8rem;">40%</span>
                            <div style="font-size: 0.75rem; color: #ef6c00;">經費編列修正中</div>
                        </td>
                        <td><span class="tag tag-gray">尚未開始</span></td>
                        <td>2026/05/27 10:15</td>
                        <td>
                            <button class="btn btn-edit" onclick="toggleCaseDetails(2)"><i class="fa-solid fa-magnifying-glass"></i> 管考</button>
                        </td>
                    </tr>
                    <!-- (此處省略 Row 2 的 Detail 以節省長度，邏輯同上) -->
                </tbody>
            </table>

            <div class="footer-btns">
                <button class="btn btn-outline">匯出所有廠商簽約進度表 (XLS)</button>
                <button class="btn btn-primary">批次發送補件通知信</button>
            </div>
        </div>
    </main>

    <script>
        // 切換詳情顯示
        function toggleCaseDetails(id) {
            const detailRow = document.getElementById(`detail-${id}`);
            if (detailRow.classList.contains('hidden-row')) {
                detailRow.classList.remove('hidden-row');
                detailRow.classList.add('expanded');
            } else {
                detailRow.classList.remove('expanded');
                detailRow.classList.add('hidden-row');
                // 關閉時自動退出編輯模式
                exitEditMode(id);
            }
        }

        // 進入編輯模式
        function enterEditMode(id) {
            const container = document.getElementById(`edit-container-${id}`);
            const editBtn = document.getElementById(`edit-btn-${id}`);
            const saveBtn = document.getElementById(`save-btn-${id}`);
            
            container.classList.add('editing');
            
            // 讓文字區塊可編輯
            const editables = container.querySelectorAll('.editable');
            editables.forEach(el => {
                if(el.tagName === 'TD') el.contentEditable = "true";
                if(el.tagName === 'TEXTAREA') el.readOnly = false;
            });

            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-flex';
        }

        // 退出編輯模式 (不儲存)
        function exitEditMode(id) {
            const container = document.getElementById(`edit-container-${id}`);
            const editBtn = document.getElementById(`edit-btn-${id}`);
            const saveBtn = document.getElementById(`save-btn-${id}`);
            
            if(!container) return;
            container.classList.remove('editing');
            
            const editables = container.querySelectorAll('.editable');
            editables.forEach(el => {
                if(el.tagName === 'TD') el.contentEditable = "false";
                if(el.tagName === 'TEXTAREA') el.readOnly = true;
            });

            editBtn.style.display = 'inline-flex';
            saveBtn.style.display = 'none';
        }

        // 儲存邏輯
        function saveCaseDetails(id) {
            // 這裡模擬 API 儲存
            alert('個案管考資料已成功儲存！\n更新內容包含：文件勾選、聯繫人資訊及撥款金額。');
            
            // 更新最後更新日期
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            const row = document.getElementById(`row-${id}`);
            row.cells[4].innerText = timeStr;

            exitEditMode(id);
        }
		// 1. 進入編輯模式：將所有指定標籤變為可打字狀態
function enterEditMode(id) {
    const wrapper = document.getElementById(`wrapper-${id}`); // 容器 ID
    wrapper.classList.add('editing'); // 套用 CSS 樣式
    
    // 讓所有有 .editable-text 類別的文字變為可編輯
    wrapper.querySelectorAll('.editable-text').forEach(el => {
        el.contentEditable = "true";
    });
    
    // 讓備註欄位可以輸入
    document.getElementById(`note-${id}`).readOnly = false;
    
    // 按鈕切換
    document.getElementById(`edit-btn-${id}`).style.display = 'none';
    document.getElementById(`save-btn-${id}`).style.display = 'inline-block';
}

// 2. 動態新增欄位函數 (以經費為例)
function addBudgetRow(id) {
    const tbody = document.getElementById(`budget-table-${id}`);
    const newRow = `
        <tr>
            <td class="editable-text" contenteditable="true">新期別項目</td>
            <td class="editable-text" contenteditable="true">0</td>
            <td class="editable-text" contenteditable="true">狀態自填</td>
            <td class="btn-del-mini" onclick="this.parentElement.remove()">×</td>
        </tr>`;
    tbody.insertAdjacentHTML('beforeend', newRow); // 在表格末尾插入
}

// 3. 儲存變更
function saveData(id) {
    const wrapper = document.getElementById(`wrapper-${id}`);
    wrapper.classList.remove('editing');
    wrapper.querySelectorAll('.editable-text').forEach(el => el.contentEditable = "false");
    document.getElementById(`note-${id}`).readOnly = true;
    
    document.getElementById(`edit-btn-${id}`).style.display = 'inline-block';
    document.getElementById(`save-btn-${id}`).style.display = 'none';
    alert("所有欄位已儲存！");
}
    </script>
</body>
</html>